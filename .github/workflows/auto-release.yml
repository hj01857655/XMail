name: 'Auto Release After CI'

on:
  workflow_run:
    workflows: ["CI Build"]
    types:
      - completed
    branches: [main, master]

jobs:
  auto-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if should auto-release
        id: check
        run: |
          # æ£€æŸ¥æœ€æ–°æäº¤æ¶ˆæ¯æ˜¯å¦åŒ…å«è‡ªåŠ¨å‘å¸ƒæ ‡è®°
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          if echo "$COMMIT_MSG" | grep -q "\[auto-release:v[0-9]\+\.[0-9]\+\.[0-9]\+\]"; then
            VERSION=$(echo "$COMMIT_MSG" | grep -o "v[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1)
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ğŸš€ æ£€æµ‹åˆ°è‡ªåŠ¨å‘å¸ƒæ ‡è®°: $VERSION"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°è‡ªåŠ¨å‘å¸ƒæ ‡è®°"
            echo "å¦‚éœ€è‡ªåŠ¨å‘å¸ƒï¼Œè¯·åœ¨æäº¤æ¶ˆæ¯ä¸­æ·»åŠ  [auto-release:v1.0.1] æ ¼å¼çš„æ ‡è®°"
          fi

      - name: Trigger release
        if: steps.check.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.check.outputs.version }}';
            const commitSha = context.sha.substring(0, 7);
            
            console.log(`è§¦å‘è‡ªåŠ¨å‘å¸ƒ: ${version}`);
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yml',
              ref: 'master',
              inputs: {
                version: version,
                release_notes: `## è‡ªåŠ¨å‘å¸ƒ ${version}

ğŸ¤– æ­¤ç‰ˆæœ¬ç”± CI æˆåŠŸåè‡ªåŠ¨å‘å¸ƒ

### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
- Windows: \`.msi\` å®‰è£…åŒ…  
- macOS: \`.dmg\` å®‰è£…åŒ… (æ”¯æŒ Intel å’Œ Apple Silicon)

### ğŸ”— ç›¸å…³ä¿¡æ¯
- åŸºäºæäº¤: ${commitSha}
- æ„å»ºæ—¶é—´: ${new Date().toISOString()}

å¦‚æœ‰é—®é¢˜è¯·è®¿é—® [Issues](https://github.com/hj01857655/XMail/issues) é¡µé¢åé¦ˆã€‚`
              }
            });