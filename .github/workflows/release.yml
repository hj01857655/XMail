name: 'Create Release'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.1)'
        required: true
        type: string
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        type: string
        default: |
          ## æ–°åŠŸèƒ½
          - 

          ## æ”¹è¿›
          - 

          ## ä¿®å¤
          - 

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "é”™è¯¯: ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ä½¿ç”¨ vX.Y.Z æ ¼å¼ (ä¾‹å¦‚: v1.0.1)"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          if git rev-parse -q --verify "refs/tags/${{ github.event.inputs.version }}" >/dev/null; then
            echo "é”™è¯¯: æ ‡ç­¾ ${{ github.event.inputs.version }} å·²å­˜åœ¨"
            exit 1
          fi

      - name: Update version in package.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" package.json

      - name: Update version in tauri.conf.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" src-tauri/tauri.conf.json

      - name: Update version in Cargo.toml
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€
          sed -i "s/^version = \".*\"/version = \"$VERSION_NUMBER\"/" src-tauri/Cargo.toml

      - name: Commit version changes
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml
          git commit -m "chore: bump version to ${{ github.event.inputs.version }}"
          git push

      - name: Create and push tag
        run: |
          git tag -a "${{ github.event.inputs.version }}" -m "Release ${{ github.event.inputs.version }}"
          git push origin "${{ github.event.inputs.version }}"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="## XMail ${{ github.event.inputs.version }}

### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

**æ”¯æŒçš„å¹³å°:**
- Windows: \`.msi\` å®‰è£…åŒ…
- macOS: \`.dmg\` å®‰è£…åŒ… (æ”¯æŒ Intel å’Œ Apple Silicon)

### âœ¨ ä¸»è¦åŠŸèƒ½
- ğŸ“§ é‚®ä»¶ç®¡ç† (åˆ›å»ºã€æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤)
- ğŸ·ï¸ åˆ†ç±»ç®¡ç†
- ğŸ” å¼ºå¤§çš„æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
- ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
- ğŸ¨ ç°ä»£åŒ–ç”¨æˆ·ç•Œé¢

### ğŸ› ï¸ æŠ€æœ¯æ ˆ
- å‰ç«¯: Vue.js 3 + Vite
- åç«¯: Rust + Tauri
- æ•°æ®åº“: SQLite

å¦‚æœ‰é—®é¢˜è¯·è®¿é—® [Issues](https://github.com/hj01857655/XMail/issues) é¡µé¢åé¦ˆã€‚"
          fi
          
          gh release create "${{ github.event.inputs.version }}" \
            --title "XMail ${{ github.event.inputs.version }}" \
            --notes "$RELEASE_NOTES" \
            --draft=false